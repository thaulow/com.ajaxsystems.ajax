<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      color: inherit;
      background: transparent;
    }
    .logo {
      text-align: center;
      margin-bottom: 24px;
      color: inherit;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      opacity: 0.7;
    }
    input, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid rgba(128,128,128,0.3);
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
      background: rgba(128,128,128,0.1);
      color: inherit;
    }
    input:focus, select:focus {
      outline: none;
      border-color: rgba(128,128,128,0.6);
      background: rgba(128,128,128,0.15);
    }
    input::placeholder {
      color: rgba(128,128,128,0.6);
    }
    option {
      background: #222;
      color: #fff;
    }
    .hint {
      font-size: 11px;
      opacity: 0.5;
      margin-top: 4px;
    }
    button {
      width: 100%;
      padding: 12px;
      background: #fff;
      color: #000;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .error {
      color: #e74c3c;
      font-size: 13px;
      margin-top: 12px;
      display: none;
    }
    .mode-fields {
      display: none;
    }
    .mode-fields.active {
      display: block;
    }
    .info-box {
      background: rgba(128,128,128,0.1);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 12px;
      line-height: 1.5;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div class="logo">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 20" height="32" fill="currentColor" aria-label="Ajax logo"><path d="M74.69.88h-5.3l21.25 19.11h5.3L74.69.88M80.83 14.48l-6.13 5.51h-5.3l6.12-5.51h5.31M89.82 6.39L95.95.88h-5.3l-6.13 5.51h5.3M13.28.88l-2.17 3.11 11.07 16h4.38L13.28.88M7.66 8.97H12L4.38 19.99H0L7.66 8.97M53.24.88l-2.17 3.11 11.07 16h4.38L53.24.88M47.62 8.97h4.34l-7.62 11.02h-4.38l7.66-11.02M35.23.88l.01 11.7c-.01 1.9-.9 4.27-3.89 4.47h-1.09v2.94s.95 0 1.57.01c1.44.02 3.52-.68 4.81-2.06 1.81-1.92 2.03-4.37 2.03-5.55V.88h-3.44"></path></svg>
  </div>

  <div class="form-group">
    <label>Connection Mode</label>
    <select id="auth_mode" onchange="toggleMode()">
      <option value="sia">SIA Protocol (Local Network)</option>
      <option value="user">Enterprise API (Direct Integration)</option>
      <option value="proxy">Proxy Server</option>
    </select>
  </div>

  <!-- SIA Mode Fields (default) -->
  <div id="sia_fields" class="mode-fields active">
    <div class="info-box">
      Receive events directly from your Ajax hub over the local network using the SIA DC-09 protocol.<br><br>
      <strong>Setup order:</strong> Fill in the fields below and click "Set Up" first. Then open the Ajax app and configure Monitoring Station settings to point to your Homey's IP address with the same port and account. The hub will send a test message to confirm the connection.
    </div>
    <div class="form-group">
      <label>Hub Name</label>
      <input type="text" id="sia_hub_name" placeholder="e.g. Home, Office" />
      <div class="hint">A name for this hub in Homey</div>
    </div>
    <div class="form-group">
      <label>Listening Port</label>
      <input type="number" id="sia_port" value="5000" min="1024" max="65535" />
      <div class="hint">TCP port Homey will listen on (configure same port in hub Monitoring Station settings)</div>
    </div>
    <div class="form-group">
      <label>Account ID</label>
      <input type="text" id="sia_account" placeholder="e.g. 1234" />
      <div class="hint">Account number configured in your hub's Monitoring Station settings</div>
    </div>
    <div class="form-group">
      <label>Encryption Key (optional)</label>
      <input type="text" id="sia_encryption_key" placeholder="Up to 32 hex or 16 ASCII characters" />
      <div class="hint">Only needed if you enabled encryption in the hub's Monitoring Station settings</div>
    </div>
    <div class="form-group">
      <label>Monitoring Station Ping (optional)</label>
      <select id="sia_ping_interval">
        <option value="0">Connect on demand (default)</option>
        <option value="1">Every 1 minute</option>
        <option value="3">Every 3 minutes</option>
        <option value="5">Every 5 minutes</option>
        <option value="10">Every 10 minutes</option>
        <option value="30">Every 30 minutes</option>
        <option value="60">Every 1 hour</option>
        <option value="720">Every 12 hours</option>
        <option value="1440">Every 24 hours</option>
      </select>
      <div class="hint">Must match "Monitoring station ping" in your hub settings. Used to detect when the hub goes offline.</div>
    </div>
  </div>

  <div id="api_key_group" class="form-group" style="display: none;">
    <label>API Key</label>
    <input type="text" id="api_key" placeholder="Your Ajax Enterprise API key" />
    <div class="hint">X-Api-Key from Ajax Systems Enterprise API</div>
  </div>

  <!-- User Mode Fields -->
  <div id="user_fields" class="mode-fields">
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="email" placeholder="Ajax account email" />
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="password" placeholder="Ajax account password" />
    </div>
    <div class="form-group">
      <label>User Role</label>
      <select id="user_role">
        <option value="USER">User</option>
        <option value="PRO">PRO (Installer)</option>
      </select>
    </div>
  </div>

  <!-- Proxy Mode Fields -->
  <div id="proxy_fields" class="mode-fields">
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="proxy_email" placeholder="Ajax account email" />
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="proxy_password" placeholder="Ajax account password" />
    </div>
    <div class="form-group">
      <label>Proxy URL</label>
      <input type="url" id="proxy_url" placeholder="https://your-proxy-server.com" />
    </div>
  </div>

  <button id="btn_login" onclick="doLogin()">Set Up</button>
  <div id="error" class="error"></div>

  <script>
    function toggleMode() {
      var mode = document.getElementById('auth_mode').value;
      document.querySelectorAll('.mode-fields').forEach(function(el) {
        el.classList.remove('active');
      });
      var fieldMap = { sia: 'sia_fields', user: 'user_fields', proxy: 'proxy_fields' };
      document.getElementById(fieldMap[mode]).classList.add('active');
      document.getElementById('api_key_group').style.display = mode === 'user' ? 'block' : 'none';
      document.getElementById('btn_login').textContent = mode === 'sia' ? 'Set Up' : 'Connect';
    }

    function doLogin() {
      var btn = document.getElementById('btn_login');
      var errEl = document.getElementById('error');
      var mode = document.getElementById('auth_mode').value;
      btn.disabled = true;
      btn.textContent = mode === 'sia' ? 'Waiting for hub message... Configure Ajax now' : 'Connecting...';
      errEl.style.display = 'none';
      var data = {
        auth_mode: mode,
        api_key: document.getElementById('api_key').value.trim()
      };

      if (mode === 'sia') {
        data.sia_hub_name = document.getElementById('sia_hub_name').value.trim();
        data.sia_port = document.getElementById('sia_port').value.trim();
        data.sia_account = document.getElementById('sia_account').value.trim();
        data.sia_encryption_key = document.getElementById('sia_encryption_key').value.trim();
        data.sia_ping_interval = document.getElementById('sia_ping_interval').value;
      } else if (mode === 'user') {
        data.email = document.getElementById('email').value.trim();
        data.password = document.getElementById('password').value;
        data.user_role = document.getElementById('user_role').value;
      } else if (mode === 'proxy') {
        data.email = document.getElementById('proxy_email').value.trim();
        data.password = document.getElementById('proxy_password').value;
        data.proxy_url = document.getElementById('proxy_url').value.trim();
      }

      Homey.emit('login', data, function(err, result) {
        if (err) {
          errEl.textContent = err.message || 'Connection failed';
          errEl.style.display = 'block';
          btn.disabled = false;
          btn.textContent = mode === 'sia' ? 'Set Up' : 'Connect';
          return;
        }

        if (mode === 'sia') {
          // Server started — now poll until the hub sends a SIA message
          btn.textContent = 'Waiting for hub message... Configure Ajax now';
          pollSiaConnection(btn, errEl);
        } else {
          Homey.showView('list_devices');
        }
      });
    }

    function pollSiaConnection(btn, errEl) {
      var attempts = 0;
      var maxAttempts = 60; // 60 × 2s = 120s
      var interval = setInterval(function() {
        attempts++;
        Homey.emit('checkSiaConnection', {}, function(err, result) {
          if (result && result.connected) {
            clearInterval(interval);
            Homey.showView('list_devices');
          } else if (attempts >= maxAttempts) {
            clearInterval(interval);
            errEl.textContent =
              'No SIA message received from hub within 120 seconds. '
              + 'Please verify your hub\'s Monitoring Station settings point '
              + 'to your Homey\'s IP address with the correct port and account. '
              + 'Try tapping "Check connection" in the Ajax app or arm/disarm your system.';
            errEl.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'Set Up';
          }
        });
      }, 2000);
    }

    // Allow Enter key to submit
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') doLogin();
    });
  </script>
</body>
</html>
